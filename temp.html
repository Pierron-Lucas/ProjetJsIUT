<!doctype html>
<html lang="fr">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capteur</title>


    <meta name="theme-color" content="#ffffff">

</head>

<body>
    <style>
        #ligne_modele {
				
            display: none;
			}
        #ligne_modele2 {
			display: none;
			}
      </style>
        
        <table role="tabpanel" id="Capteur_interieur">
        <tr><th colspan="2">Capteurs</th></tr>
        <tr>
            <th>Nom capteur</th>
            <th>type</th>
          <th>Date</th>
          <th>heure</th>
          <th>Température</th>
          <th>Nom capteur</th>
            <th>type</th>
          <th>Date</th>
          <th>heure</th>
          <th>Température</th>
          
        </tr>
        <tr id="ligne_modele">
            <td class="td_Nom"></td>
            <td class="td_type"></td>
          <td class="td_date"></td>
          <td class="td_hour"></td>
          <td class="td_temperature">
          </td>
          <td class="td_Nom2"></td>
          <td class="td_type2"></td>
        <td class="td_date2"></td>
        <td class="td_hour2"></td>
        <td class="td_temperature2"></td>
        </tr>
      </table>
    <p id='status'></p>
    <code id='datas'></code>
    <button id='notifications'> Notification</button>
    
    
    <script> socket = new WebSocket("wss://ws.hothothot.dog:9502");
               
                function getSensors(){
                socket.onmessage = function (event) {
                var json = JSON.parse(event.data);
                datas = document.getElementById("datas");
                datas.innerHTML= event.data;
                var date = new Date(json.capteurs[0].Timestamp*1000);
                var currentdate = date.getDate()+"/" +date.getMonth()+"/"+date.getFullYear();
                var datehour = date.getHours()+":" + date.getMinutes()+":"+date.getSeconds();
                TempCapteurInterieur = parseFloat(json.capteurs[0].Valeur);
                TempCapteurExterieur = parseFloat(json.capteurs[1].Valeur);
                
                let clone_capteur_interieur = document.getElementById("ligne_modele").cloneNode(true);
						clone_capteur_interieur.setAttribute("id", "");
                        clone_capteur_interieur.querySelector(".td_Nom").innerText = json.capteurs[0].Nom
                        clone_capteur_interieur.querySelector(".td_type").innerText = json.capteurs[0].type
						clone_capteur_interieur.querySelector(".td_date").innerText = currentdate;
                        clone_capteur_interieur.querySelector(".td_hour").innerText = datehour;
                        clone_capteur_interieur.querySelector(".td_temperature").innerText = json.capteurs[0].Valeur;
                        clone_capteur_interieur.querySelector(".td_Nom2").innerText = json.capteurs[1].Nom
                        clone_capteur_interieur.querySelector(".td_type2").innerText = json.capteurs[1].type
						clone_capteur_interieur.querySelector(".td_date2").innerText = currentdate;
                        clone_capteur_interieur.querySelector(".td_hour2").innerText = datehour;
                        clone_capteur_interieur.querySelector(".td_temperature2").innerText = json.capteurs[1].Valeur;
						clone_capteur_interieur.style.display = "table-row";
						let table_tbody = document.querySelector("table tbody");
                        table_tbody.insertBefore(clone_capteur_interieur,table_tbody.querySelector("#ligne_modele").nextSibling);
                     
                        
                        
                }
        }
        socket.onopen = function (event) {
            console.log("Connexion établie");

            //On indique sur notre page web que la connexion est établie
            let label = document.getElementById("status");
            label.innerHTML = "Connexion établie";

            //Envoi d'un message au serveur (obligatoire)
            socket.send("coucou !");

            // au retour...
             getSensors();
             
                 
             
               


            }
           
    
        function getNotifications() {
                var notifTitle = "voici la température des capteurs ";
                var notifBody = 'Température des capteurs : capteur intérieur : ' + TempCapteurInterieur + ' capteur extérieur' + TempCapteurExterieur +'.';
                var notifImg = '/assets/images/android-chrome-192x192.png';
                var options = {
                    body: notifBody,
                    icon: notifImg
                }
                var notif = new Notification(notifTitle, options);
            }
          
            setTimeout(getNotifications, 30000);

        
        var button = document.getElementById("notifications");
        button.addEventListener('click', function (e) {
            Notification.requestPermission().then(function (result) {
                if (result === 'granted') {
                    getNotifications();
                }
            });
        });
        
 
    </script>
</body>

</html>